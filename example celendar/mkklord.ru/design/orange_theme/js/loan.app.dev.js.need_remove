function LoanApp()
{
    var app = this;
    
    var DEBUG = 1;
    
    app.$form;
    app.sms_timer;
    app.sms_delay = 0;
    
    app.init = function(){

        app.$form = $('#loan_form');

    };
    
    app.init_events = function(){
        
        // клик по кнопке "Отправить еще раз"
        app.$form.find('.js-send-again').click(function(e){
            e.preventDefault();
            if ($(this).is(':visible'))
            {
                _send_code();
            }
        });
        
        // клик по кнопке "Отправить код"
        app.$form.find('.js-send-code').click(function(e){
            e.preventDefault();
            if ($(this).is(':visible'))
            {
                if (app.$form.valid())
                    _send_code();
            }
        });
        
        // открытие модалки с правилами
        app.$form.find('#accept_link').click(function(e){
            e.preventDefault();
        	$.magnificPopup.open({
        		items: {
        			src: '#accept'
        		},
        		type: 'inline',
                showCloseBtn: true
        	});
        });
        
        // изменение номера телефона
        app.$form.find('[name=phone]').change(function(){
            $(this).closest('label').removeClass('error');
            
            app.$form.find('.js-info-block').hide();
            app.$form.find('[name=code]').val('');
            app.$form.find('.js-send-block').show()
        });
        
        // изменение поля с кодом
        app.$form.find('.js-input-code').change(function(){
            _check_code();
        });
        
//        app.$form.find('input').change(_check_form)
    };
    
    var _check_code = function(){
        
        var _code = app.$form.find('.js-input-code').val();
        var _phone = app.$form.find('.js-input-phone').val();
    
        $.ajax({
            url: 'ajax/loan.php',
            data: {
                action: 'check_code',
                phone: _phone,
                code: _code
            },
            beforeSend: function(){
                app.$form.addClass('loading');
            },
            success: function(resp){
                if (!!resp.error)
                {
                    app.$form.find('.js-code-block').addClass('error');
                    app.$form.find('.js-code-block').find('.error').text('Код не совпадает');
                    
                    app.$form.find('#phone_checked').val('0')
                }
                else if (!!resp.success)
                {
                    app.$form.find('.js-send-repeat').hide();
                    app.$form.find('.js-send-again').hide();
                    app.$form.find('.js-send-text').hide();
                    app.$form.find('.js-code-block').hide();
                    app.$form.find('.js-send-block').hide();
                    app.$form.find('.js-accept-block').fadeIn();
                    app.$form.find('.js-submit-block').fadeIn();
                    
                    app.$form.find('#phone_checked').val('1')
                    
                    app.$form.find('.js-info-block').removeClass('error').addClass('text-left').html('<span class="success"> Телефон подтвержен</span>').fadeIn();
                }
            },
            complete: function(){
                app.$form.removeClass('loading');
            }
        });
    };
    
    var _send_code = function(){
        
        var _phone = app.$form.find('[name=phone]').val();
        
        
            $.ajax({
                url: 'ajax/loan.php',
                data: {
                    action: 'send_code',
                    phone: _phone
                },
                beforeSend: function(){
                    app.$form.addClass('loading');
                },
                success: function(resp){
                    
                    if (!!resp.error)
                    {
                        if (resp.error == 'user_blocked')
                        {
                            var _str = '<span class="error-text">Пользователь с таким номером уже зарегистрован.<br />С Вами свяжется Клиентский Центр.</span>';
                            app.$form.find('.js-info-block').addClass('error').html(_str).fadeIn();
                            app.$form.find('.js-send-code').hide();
                        }
                        else if (resp.error == 'user_exists')
                        {
                            var _str = '<span class="error-text">Пользователь с таким номером уже зарегистрован.<br /><a class="error-a" href="user/login?phone='+_phone+'">Воспользуйтесь формой входа для клиентов</a></span>';
                            app.$form.find('.js-info-block').addClass('error').html(_str).fadeIn();
                            app.$form.find('.js-send-code').hide();
                        }
                        else if (resp.error == 'sms_time')
                        {
                            app.sms_delay = resp.sms_time;
                            _run_sms_timer();
                        }
                        else if (resp.error == 'dont_work')
                        {
                            var _str = '<span class="error-text">Новые заявки принимаются с 7:00 до 17:00(мск)<br />Попробуйте в рабочее время.</span>';
                            app.$form.find('.js-info-block').addClass('error').html(_str).fadeIn();
                            app.$form.find('.js-send-code').hide();
                        }
                        else
                        {  
                            app.$form.find('.js-info-block').addClass('error').html(resp.error).fadeIn();
                            app.$form.find('.js-send-code').show();
                            
                            if (!!DEBUG)
                                console.error(resp.error);
                        }
                    } 
                    else
                    {
                        if (!!DEBUG)
                            console.info(resp);
                            
                        app.$form.find('.step1').hide();
                        app.$form.find('.step2').fadeIn();
                            /*
                        app.$form.find('.js-send-block').show();
                        app.$form.find('.js-code-block').show();  
                        app.$form.find('.js-send-code').hide();   
                        */
                        /** расскоментить на раб версии, подтверждение кода для разработчика
                        if (!!resp.code)
                            app.$form.find('.js-input-code').val(resp.code).change();
                        */
                        
                        app.sms_delay = resp.sms_time;
                        _run_sms_timer();
                    }
                },
                complete: function(){
                    app.$form.removeClass('loading');
                }
            })
        
    };
    
    
    app.init_masks = function(){
        
        app.$form.find('[name=email]').inputmask({
            mask: "*{1,20}[.*{1,20}][.*{1,20}][.*{1,20}]@*{1,20}[.*{2,6}][.*{1,2}]",
            greedy: false,
            definitions: {
                '*': {
                    validator: "[0-9A-Za-z!#$%&'*+/=?^_`{|}~\-]",
                    cardinality: 1,
                    casing: "lower",
                    clearIncomplete: false
                }
            }
        });

        app.$form.find('[name=phone]').inputmask(
            "+7 (999) 999-99-99",
            {
                oncomplete: function (e) {
                    $(e.target).parent().next().find('input').focus();
                },
                clearIncomplete: false
            }
        );
        
        

    };
    
    app.run_validate = function(){
         app.$form.validate({
            errorElement: "span",
    		rules: {
    			"firstname": {
    				russian: true
    			},
    			"lastname": {
    				russian: true
    			},
    			"patronymic": {
    				russian: true
    			},
                "email": {
                    user_email:true
                },
    			"birthday": {
    				Birth: true
    			},
    			"phone": {
    				only_mobile: true
    			}
    		},
            submitHandler: function(form) {
                
                if (!app.$form.find('.js-input-accept').is(':checked'))
                {
                    app.$form.find('.js-accept-block').addClass('error');
                }
                else if (app.$form.find('.js-input-code').val() == '' || app.$form.find('#phone_checked').val() == 0)
                {
                    app.$form.find('.js-code-block').addClass('error').fadeIn();
                }
                else
                {
                    app.$form.find('.js-accept-block').removeClass('error');

                    if (!is_developer)
                    {
                        ym(45594498,'reachGoal','info');
                    }
                    else
                    {
                        console.info('ym reachGoal info');
                    }

                    app.$form.addClass('loading')
                    form.submit();
                    
                }
                
            }
         });
    };
    
    var _check_form = function(){
        if (!!DEBUG)
            console.log( "Valid: " + app.$form.valid() );


    }
    
    var _run_sms_timer = function(){
        
        clearInterval(app.sms_timer);
        
        app.sms_timer = setInterval(function(){
            app.sms_delay--;
            if (app.sms_delay > 0)
            {
                app.$form.find('.js-send-again').hide();
                app.$form.find('.js-send-repeat').show();
                
                var _str = '<span>Повторно отправить код можно через '+app.sms_delay+'сек</span>';
                app.$form.find('.js-send-repeat').html(_str).show();
            }
            else
            {
                app.$form.find('.js-send-again').text('Отправить еще').show();
                app.$form.find('.js-send-repeat').hide();
                
                clearInterval(app.sms_timer);
            }
        }, 1000);
        
    };
    
    ;(function(){
        
        app.init();
        app.init_masks();
        app.init_events();
        
        app.run_validate();
    })();
    
    
//    console.log(app.$form.find('[name=email]').data('email'))
    if (app.$form.find('[name=email]').data('email') != '')
        app.$form.find('[name=email]').val(app.$form.find('[name=email]').data('email'))
};


$(function(){
    if ($('#loan_form').length > 0)
        new LoanApp();
});